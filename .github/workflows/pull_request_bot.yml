name: ðŸ¤– PR Comment Bot

on:
  pull_request:
    types: [opened, edited, reopened]

jobs:
  validar-template:
    runs-on: ubuntu-latest
    steps:
      - name: Verificar conteÃºdo do PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = context.payload.pull_request.body || "";
            const title = context.payload.pull_request.title || "";

            // Ignora PRs relacionados ao prÃ³prio bot
            if (title.toLowerCase().includes("pull_request_bot")) {
              console.log("â­ï¸ PR ignorado por tÃ­tulo.");
              return;
            }

            const obrigatorios = [
              "- [x] O cÃ³digo funciona localmente sem erros",
              "- [x] A branch estÃ¡ atualizada com develop",
              "- [x] O PR foi atribuÃ­do a pelo menos 1 revisor"
            ];

            const secoesObrigatorias = [
              "## ðŸ“‹ Checklist do PR",
              "## ðŸ“„ DescriÃ§Ã£o",
              "## ðŸ“· Screenshots (se aplicÃ¡vel)",
              "## â° ReferÃªncia (Notion, tarefa, issue, etc.)"
            ];

            let erros = [];

            // Aceita frases curtas e comuns como vÃ¡lidas
            const aceitaveis = [
              "nÃ£o se aplica",
              "sem screenshots",
              "sem referÃªncia",
              "nenhuma referÃªncia",
              "nÃ£o necessÃ¡rio"
            ];

            // Verifica se cada seÃ§Ã£o existe e tem conteÃºdo relevante
            secoesObrigatorias.forEach(secao => {
              const regex = new RegExp(`${secao}\\s*\\n+([\\s\\S]*?)(?=\\n##|$)`, 'i');
              const match = body.match(regex);
              const conteudo = match && match[1] ? match[1].trim() : "";

              if (!conteudo || aceitaveis.includes(conteudo.toLowerCase()) || conteudo.startsWith("---")) {
                erros.push(`âŒ A seÃ§Ã£o "${secao}" estÃ¡ vazia ou com conteÃºdo irrelevante.`);
              }
            });

            // Verifica se os checkboxes obrigatÃ³rios estÃ£o marcados (tolerante a variaÃ§Ãµes)
            obrigatorios.forEach(item => {
              const baseTexto = item.replace("- [x]", "").trim().toLowerCase();
              const regex = new RegExp(`- \\[x\\] .*${baseTexto}.*`, "i");
              if (!regex.test(body)) {
                erros.push(`âŒ Checklist obrigatÃ³rio nÃ£o marcado corretamente: "${item}"`);
              }
            });

            if (erros.length > 0) {
              core.setFailed(erros.join("\n"));
            } else {
              console.log("âœ… Template validado com sucesso.");
            }
