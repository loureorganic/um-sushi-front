name: 🤖 PR Comment Bot

on:
  pull_request:
    types: [opened, edited, reopened]

jobs:
  validar-template:
    runs-on: ubuntu-latest
    steps:
      - name: Verificar conteúdo do PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = context.payload.pull_request.body || "";

            const obrigatorios = [
              "- [x] O código funciona localmente sem erros",
              "- [x] A branch está atualizada com develop",
              "- [x] O PR foi atribuído a pelo menos 1 revisor",
            ];

            const secoesObrigatorias = [
              "## 📋 Checklist do PR",
              "## 📄 Descrição",
              "## 📷 Screenshots (se aplicável)",
              "## ⏰ Referência (Notion, tarefa, issue, etc.)"
            ];

            let erros = [];

            // Regex melhorada: captura tudo até a próxima seção ou fim do body
            secoesObrigatorias.forEach(secao => {
              const regex = new RegExp(`${secao}\\s*\\n+([\\s\\S]*?)(?=\\n##|$)`, 'i');
              const match = body.match(regex);
              if (!match || !match[1].trim()) {
                erros.push(`❌ A seção "${secao}" está vazia ou ausente.`);
              }
            });

            // Verifica se os checkboxes obrigatórios estão marcados
            obrigatorios.forEach(item => {
              if (!body.includes(item)) {
                erros.push(`❌ Checklist obrigatório não marcado: "${item}"`);
              }
            });

            if (erros.length > 0) {
              core.setFailed(erros.join("\n"));
            } else {
              console.log("✅ Template validado com sucesso.");
            }
